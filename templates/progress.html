{% extends "base.html" %}

{% block title %}Progress Tracking - Mindful Horizon{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Your Mental Health Progress</h1>
        <p class="text-gray-600">Track your mental health journey with detailed insights and trends</p>
    </div>

    <div class="grid md:grid-cols-3 gap-6 mb-8">
        <div class="card">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Anxiety Levels</h3>
                <i class="fas fa-heart text-blue-500 text-xl"></i>
            </div>
            <div class="text-3xl font-bold text-blue-600 mb-2">{{ latest_gad7.score if latest_gad7 else 'N/A' }}{% if latest_gad7 %}/21{% endif %}</div>
            <div class="text-sm text-gray-600 mb-3">Latest GAD-7 Score</div>
            <div class="flex items-center">
                {% if latest_gad7 %}
                    {% set severity_info = get_severity_info('GAD-7', latest_gad7.score) %}
                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-{{ severity_info.color }}-100 text-{{ severity_info.color }}-800">{{ severity_info.severity }}</span>
                {% else %}
                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">No Data</span>
                {% endif %}
                <span class="ml-2 text-sm text-gray-600">
                    </span>
            </div>
        </div>

        <div class="card">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Depression Screen</h3>
                <i class="fas fa-brain text-purple-500 text-xl"></i>
            </div>
            <div class="text-3xl font-bold text-purple-600 mb-2">{{ latest_phq9.score if latest_phq9 else 'N/A' }}{% if latest_phq9 %}/27{% endif %}</div>
            <div class="text-sm text-gray-600 mb-3">Latest PHQ-9 Score</div>
            <div class="flex items-center">
                {% if latest_phq9 %}
                    {% set severity_info = get_severity_info('PHQ-9', latest_phq9.score) %}
                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-{{ severity_info.color }}-100 text-{{ severity_info.color }}-800">{{ severity_info.severity }}</span>
                {% else %}
                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">No Data</span>
                {% endif %}
                <span class="ml-2 text-sm text-gray-600">
                    </span>
            </div>
        </div>

        <div class="card">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Overall Wellness</h3>
                <i class="fas fa-chart-line text-green-500 text-xl"></i>
            </div>
            <div class="text-3xl font-bold text-green-600 mb-2">{{ overall_wellness_score }}</div>
            <div class="text-sm text-gray-600 mb-3">AI Wellness Score</div>
            <div class="flex items-center">
                {% if overall_wellness_score != 'N/A' %}
                    {% set severity_info = get_severity_info('Daily Mood', overall_wellness_score) %}
                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-{{ severity_info.color }}-100 text-{{ severity_info.color }}-800">{{ severity_info.severity }}</span>
                {% else %}
                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">No Data</span>
                {% endif %}
                <span class="ml-2 text-sm text-gray-600">
                    </span>
            </div>
        </div>
    </div>

    <div class="grid lg:grid-cols-2 gap-8 mb-8">
        <div class="card">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-smile text-yellow-500 mr-2"></i>Mood Trends (Last 30 Days)
            </h3>
            <div class="bg-gray-50 p-4 rounded-lg mb-4" style="height: 250px;">
                <canvas id="moodChart"></canvas>
            </div>
            <div class="text-sm text-gray-600">
                <i class="fas fa-info-circle mr-2"></i>
                Your mood trends over time.
            </div>
        </div>

        <div class="card">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-chart-bar text-blue-500 mr-2"></i>Assessment Score History
            </h3>
            <div class="bg-gray-50 p-4 rounded-lg mb-4" style="height: 250px;">
                <canvas id="assessmentChart"></canvas>
            </div>
            <div class="text-sm text-gray-600">
                <i class="fas fa-info-circle mr-2"></i>
                Anxiety (GAD-7) and Depression (PHQ-9) scores over time.
            </div>
        </div>
    </div>

    <div class="card mb-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">
            <i class="fas fa-robot text-purple-500 mr-2"></i>AI Progress Analysis
        </h3>
        
        <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-lg mb-6">
            <h4 class="font-semibold text-gray-800 mb-3">Personalized Insights</h4>
            <div class="space-y-3 text-sm text-gray-700">
                <div class="flex items-start">
                    <i class="fas fa-check-circle text-green-500 mr-3 mt-1"></i>
                    <span><strong>Positive Trend:</strong> Your anxiety levels have decreased by 25% over the past month, indicating effective coping strategies.</span>
                </div>
                <div class="flex items-start">
                    <i class="fas fa-lightbulb text-yellow-500 mr-3 mt-1"></i>
                    <span><strong>Recommendation:</strong> Your mood dips typically occur on Mondays. Consider implementing weekend self-care routines.</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">
            <i class="fas fa-target text-red-500 mr-2"></i>Mental Health Goals
        </h3>
        <div id="goals-container" class="space-y-2">
            {% for goal in goals %}
            <div class="flex items-center p-2 rounded-lg {% if goal.completed %}bg-green-100{% else %}bg-gray-100{% endif %}">
                <input type="checkbox" data-goal-id="{{ goal.id }}" class="form-checkbox h-5 w-5 text-blue-600" {% if goal.completed %}checked{% endif %}>
                <span class="ml-3 text-gray-700">{{ goal.description }}</span>
            </div>
            {% endfor %}
        </div>
        <div class="mt-4">
            <form id="add-goal-form" class="flex items-center">
                <input type="text" id="new-goal-description" class="input-field flex-grow" placeholder="Add a new goal...">
                <button type="submit" class="btn-primary ml-2">Add</button>
            </form>
        </div>
    </div>

    <div class="card mb-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">
            <i class="fas fa-trophy text-yellow-500 mr-2"></i>Achievements
        </h3>
        <ul id="achievements-list" class="space-y-2 text-sm text-green-700">
            {% for achievement in achievements %}
            <li class="flex items-center">
                <i class="fas fa-star text-yellow-500 mr-2"></i>
                {{ achievement }}
            </li>
            {% endfor %}
        </ul>
    </div>

    <div class="grid md:grid-cols-2 gap-6">
        <div class="card">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-tasks text-orange-500 mr-2"></i>Recommended Actions
            </h3>
            <div class="space-y-3">
                <div class="flex items-start p-3 bg-orange-50 rounded-lg">
                    <i class="fas fa-exclamation-triangle text-orange-500 mr-3 mt-1"></i>
                    <div>
                        <div class="font-medium text-orange-800">Schedule Check-in</div>
                        <div class="text-sm text-orange-700">Your last provider session was 2 weeks ago</div>
                    </div>
                </div>
                <div class="flex items-start p-3 bg-blue-50 rounded-lg">
                    <i class="fas fa-book text-blue-500 mr-3 mt-1"></i>
                    <div>
                        <div class="font-medium text-blue-800">Complete Assessment</div>
                        <div class="text-sm text-blue-700">Monthly GAD-7 and PHQ-9 due in 3 days</div>
                    </div>
                </div>
                <div class="flex items-start p-3 bg-green-50 rounded-lg">
                    <i class="fas fa-heart text-green-500 mr-3 mt-1"></i>
                    <div>
                        <div class="font-medium text-green-800">Self-Care Reminder</div>
                        <div class="text-sm text-green-700">Try the new breathing exercise in your toolkit</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Insights & Tips
            </h3>
            <div class="space-y-4">
                <div class="p-3 bg-yellow-50 rounded-lg">
                    <div class="font-medium text-yellow-800 mb-2">Sleep Pattern Insight</div>
                    <div class="text-sm text-yellow-700">Your mood scores are 15% higher on days when you sleep 7+ hours. Consider maintaining a consistent bedtime routine.</div>
                </div>
                <div class="p-3 bg-purple-50 rounded-lg">
                    <div class="font-medium text-purple-800 mb-2">Activity Correlation</div>
                    <div class="text-sm text-purple-700">Physical activity days correlate with improved mood. Try to maintain your current exercise routine.</div>
                </div>
                <div class="p-3 bg-indigo-50 rounded-lg">
                    <div class="font-medium text-indigo-800 mb-2">Social Connection</div>
                    <div class="text-sm text-indigo-700">Your wellness scores improve after social interactions. Consider scheduling regular social activities.</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeMoodChart();
    initializeAssessmentChart();
    initializeGoals();
});

function initializeGoals() {
    const addGoalForm = document.getElementById('add-goal-form');
    addGoalForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const descriptionInput = document.getElementById('new-goal-description');
        const description = descriptionInput.value;
        if (description) {
            const response = await fetch('/api/goals', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ description })
            });
            const result = await response.json();
            if (result.success) {
                addGoalToDOM(result.goal);
                descriptionInput.value = '';
            }
        }
    });

    const goalsContainer = document.getElementById('goals-container');
    goalsContainer.addEventListener('change', async (e) => {
        if (e.target.type === 'checkbox') {
            const goalId = e.target.dataset.goalId;
            const completed = e.target.checked;
            const response = await fetch(`/api/goals/${goalId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ completed })
            });
            const result = await response.json();
            if (result.success) {
                updateGoalInDOM(e.target);
                updateAchievements();
            }
        }
    });
}

function addGoalToDOM(goal) {
    const goalsContainer = document.getElementById('goals-container');
    const goalElement = document.createElement('div');
    goalElement.className = 'flex items-center p-2 rounded-lg bg-gray-100';
    goalElement.innerHTML = `
        <input type="checkbox" data-goal-id="${goal.id}" class="form-checkbox h-5 w-5 text-blue-600">
        <span class="ml-3 text-gray-700">${goal.description}</span>
    `;
    goalsContainer.appendChild(goalElement);
}

function updateGoalInDOM(checkbox) {
    const goalElement = checkbox.parentElement;
    if (checkbox.checked) {
        goalElement.classList.remove('bg-gray-100');
        goalElement.classList.add('bg-green-100');
    } else {
        goalElement.classList.remove('bg-green-100');
        goalElement.classList.add('bg-gray-100');
    }
}

function updateAchievements() {
    const achievementsList = document.getElementById('achievements-list');
    achievementsList.innerHTML = '';
    const completedGoals = document.querySelectorAll('#goals-container input[type="checkbox"]:checked');
    completedGoals.forEach(goal => {
        const achievementElement = document.createElement('li');
        achievementElement.className = 'flex items-center';
        achievementElement.innerHTML = `
            <i class="fas fa-star text-yellow-500 mr-2"></i>
            ${goal.nextElementSibling.textContent}
        `;
        achievementsList.appendChild(achievementElement);
    });
}


function initializeMoodChart() {
    const canvas = document.getElementById('moodChart');
    const ctx = canvas.getContext('2d');
    
    // Get data from Flask template
    const moodData = JSON.parse('{{ mood_data | tojson }}');
    
    if (moodData.length === 0) {
        // Display a message if no data
        ctx.font = '16px Inter';
        ctx.textAlign = 'center';
        ctx.fillStyle = '#6B7280';
        ctx.fillText('No mood data available yet', canvas.width / 2, canvas.height / 2);
        ctx.fillText('Start tracking your daily mood to see trends here', canvas.width / 2, canvas.height / 2 + 25);
        return;
    }
    
    // Extract dates and mood scores
    const dates = moodData.map(item => {
        const date = new Date(item.date);
        return (date.getMonth() + 1) + '/' + date.getDate();
    });
    const scores = moodData.map(item => item.score);
    
    drawLineChart(ctx, canvas, dates, scores, 'Mood Score', '#F59E0B');
}

function initializeAssessmentChart() {
    const canvas = document.getElementById('assessmentChart');
    const ctx = canvas.getContext('2d');
    
    // Get data from Flask template
    const labels = JSON.parse('{{ assessment_chart_labels | tojson }}');
    const gad7Data = JSON.parse('{{ assessment_chart_gad7_data | tojson }}');
    const phq9Data = JSON.parse('{{ assessment_chart_phq9_data | tojson }}');

    if (labels.length === 0) {
        // Display a message if no data
        ctx.font = '16px Inter';
        ctx.textAlign = 'center';
        ctx.fillStyle = '#6B7280';
        ctx.fillText('No assessment data available yet', canvas.width / 2, canvas.height / 2);
        ctx.fillText('Complete your first assessment to see progress here', canvas.width / 2, canvas.height / 2 + 25);
        return;
    }
    
    drawDualLineChart(ctx, canvas, labels, gad7Data, phq9Data);
}

function drawLineChart(ctx, canvas, xData, yData, label, color) {
    const padding = 40;
    const width = canvas.width - 2 * padding;
    const height = canvas.height - 2 * padding;
    
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Find min and max values
    const minY = Math.min(...yData);
    const maxY = Math.max(...yData);
    const yRange = maxY - minY || 1; // Avoid division by zero
    
    // Draw axes
    ctx.strokeStyle = '#E5E7EB';
    ctx.lineWidth = 1;
    
    // Y-axis
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, canvas.height - padding);
    ctx.stroke();
    
    // X-axis
    ctx.beginPath();
    ctx.moveTo(padding, canvas.height - padding);
    ctx.lineTo(canvas.width - padding, canvas.height - padding);
    ctx.stroke();
    
    // Draw grid lines and labels
    ctx.font = '12px Inter';
    ctx.fillStyle = '#6B7280';
    ctx.textAlign = 'center';
    
    // Y-axis labels
    for (let i = 0; i <= 5; i++) {
        const y = canvas.height - padding - (i / 5) * height;
        const value = minY + (i / 5) * yRange;
        
        ctx.fillText(value.toFixed(1), padding - 15, y + 4);
        
        if (i > 0) {
            ctx.strokeStyle = '#F3F4F6';
            ctx.beginPath();
            ctx.moveTo(padding, y);
            ctx.lineTo(canvas.width - padding, y);
            ctx.stroke();
        }
    }
    
    // X-axis labels
    const step = Math.ceil(xData.length / 6);
    for (let i = 0; i < xData.length; i += step) {
        const x = padding + (i / (xData.length - 1)) * width;
        ctx.fillText(xData[i], x, canvas.height - padding + 20);
    }
    
    // Draw data line
    drawDataLine(ctx, padding, width, height, yData, minY, yRange, color);
}

function drawDualLineChart(ctx, canvas, xLabels, data1, data2) {
    const padding = 40;
    const width = canvas.width - 2 * padding;
    const height = canvas.height - 2 * padding;
    
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Find min and max values across both datasets
    const allData = [...data1, ...data2];
    const minY = Math.min(...allData);
    const maxY = Math.max(...allData);
    const yRange = maxY - minY || 1;
    
    // Draw axes (same as single line chart)
    ctx.strokeStyle = '#E5E7EB';
    ctx.lineWidth = 1;
    
    // Y-axis
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, canvas.height - padding);
    ctx.stroke();
    
    // X-axis
    ctx.beginPath();
    ctx.moveTo(padding, canvas.height - padding);
    ctx.lineTo(canvas.width - padding, canvas.height - padding);
    ctx.stroke();
    
    // Draw grid and labels (same as single line chart)
    ctx.font = '12px Inter';
    ctx.fillStyle = '#6B7280';
    ctx.textAlign = 'center';
    
    // Y-axis labels
    for (let i = 0; i <= 5; i++) {
        const y = canvas.height - padding - (i / 5) * height;
        const value = minY + (i / 5) * yRange;
        
        ctx.fillText(value.toFixed(0), padding - 15, y + 4);
        
        if (i > 0) {
            ctx.strokeStyle = '#F3F4F6';
            ctx.beginPath();
            ctx.moveTo(padding, y);
            ctx.lineTo(canvas.width - padding, y);
            ctx.stroke();
        }
    }
    
    // X-axis labels
    const step = Math.ceil(xLabels.length / 6);
    for (let i = 0; i < xLabels.length; i += step) {
        const x = padding + (i / (xLabels.length - 1)) * width;
        ctx.fillText(xLabels[i], x, canvas.height - padding + 20);
    }
    
    // Draw both data lines
    drawDataLine(ctx, padding, width, height, data1, minY, yRange, '#3B82F6'); // Blue for GAD-7
    drawDataLine(ctx, padding, width, height, data2, minY, yRange, '#8B5CF6'); // Purple for PHQ-9
    
    // Draw legend
    ctx.font = '12px Inter';
    ctx.textAlign = 'left';
    
    // GAD-7 legend
    ctx.fillStyle = '#3B82F6';
    ctx.fillRect(canvas.width - 150, 20, 15, 3);
    ctx.fillStyle = '#374151';
    ctx.fillText('GAD-7 (Anxiety)', canvas.width - 130, 25);
    
    // PHQ-9 legend
    ctx.fillStyle = '#8B5CF6';
    ctx.fillRect(canvas.width - 150, 40, 15, 3);
    ctx.fillStyle = '#374151';
    ctx.fillText('PHQ-9 (Depression)', canvas.width - 130, 45);
}

function drawDataLine(ctx, padding, width, height, data, minY, yRange, color) {
    if (data.length === 0) return;
    
    ctx.strokeStyle = color;
    ctx.fillStyle = color;
    ctx.lineWidth = 2;
    
    ctx.beginPath();
    for (let i = 0; i < data.length; i++) {
        const x = padding + (i / (data.length - 1)) * width;
        const y = canvas.height - padding - ((data[i] - minY) / yRange) * height;
        
        if (i === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
        
        // Draw data points
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, 2 * Math.PI);
        ctx.fill();
        ctx.beginPath();
    }
    ctx.stroke();
}

function setNewGoal() {
    // This would typically open a modal or redirect to a goal-setting page
    showNotification('Goal setting feature coming soon!', 'info');
}

function showNotification(message, type) {
    // Simple notification system
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
{% endblock %}