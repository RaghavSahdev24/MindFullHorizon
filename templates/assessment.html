{% extends "base.html" %}

{% block title %}Mental Health Assessment - Mindful Horizon{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Mental Health Assessment</h1>
        <p class="text-gray-600">Complete this assessment to track your mental well-being and get personalized insights</p>
    </div>

    <!-- Assessment Selection -->
    <div class="grid md:grid-cols-2 gap-6 mb-8">
        <div class="card cursor-pointer hover:shadow-xl transition-all duration-300" onclick="startAssessment('anxiety')">
            <div class="text-center">
                <div class="bg-blue-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-heart text-blue-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Anxiety Assessment (GAD-7)</h3>
                <p class="text-gray-600 text-sm mb-4">7-question screening for generalized anxiety disorder</p>
                <div class="bg-blue-50 p-3 rounded-lg">
                    <span class="text-sm text-blue-700">‚è±Ô∏è Takes 3-5 minutes</span>
                </div>
            </div>
        </div>

        <div class="card cursor-pointer hover:shadow-xl transition-all duration-300" onclick="startAssessment('depression')">
            <div class="text-center">
                <div class="bg-purple-100 rounded-full w-16 h-16 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-brain text-purple-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Depression Screening (PHQ-9)</h3>
                <p class="text-gray-600 text-sm mb-4">9-question assessment for depression symptoms</p>
                <div class="bg-purple-50 p-3 rounded-lg">
                    <span class="text-sm text-purple-700">‚è±Ô∏è Takes 5-7 minutes</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Mood Check -->
    <div class="card mb-8">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">
            <i class="fas fa-smile text-yellow-500 mr-2"></i>Daily Mood Check
        </h3>
        <p class="text-gray-600 mb-4">How are you feeling today? This helps track your mood patterns over time.</p>
        
        <div class="grid grid-cols-5 gap-4 mb-4">
            <div class="text-center cursor-pointer mood-option" data-mood="1" onclick="selectMood(1)">
                <div class="text-4xl mb-2">üò¢</div>
                <span class="text-sm text-gray-600">Very Low</span>
            </div>
            <div class="text-center cursor-pointer mood-option" data-mood="2" onclick="selectMood(2)">
                <div class="text-4xl mb-2">üòü</div>
                <span class="text-sm text-gray-600">Low</span>
            </div>
            <div class="text-center cursor-pointer mood-option" data-mood="3" onclick="selectMood(3)">
                <div class="text-4xl mb-2">üòê</div>
                <span class="text-sm text-gray-600">Neutral</span>
            </div>
            <div class="text-center cursor-pointer mood-option" data-mood="4" onclick="selectMood(4)">
                <div class="text-4xl mb-2">üôÇ</div>
                <span class="text-sm text-gray-600">Good</span>
            </div>
            <div class="text-center cursor-pointer mood-option" data-mood="5" onclick="selectMood(5)">
                <div class="text-4xl mb-2">üòä</div>
                <span class="text-sm text-gray-600">Excellent</span>
            </div>
        </div>
        
        <div class="flex justify-center">
            <button id="saveMoodBtn" class="btn-primary" onclick="saveDailyMood()" disabled>
                <i class="fas fa-save mr-2"></i>Save Today's Mood
            </button>
        </div>
    </div>

    <!-- Assessment History -->
    <div class="card">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">
            <i class="fas fa-chart-line text-green-500 mr-2"></i>Your Assessment History
        </h3>
        
        <div class="overflow-x-auto">
            <table class="w-full table-auto">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Date</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Assessment Type</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Score</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Severity</th>
                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Actions</th>
                    </tr>
                </thead>
                <tbody id="assessmentHistory">
                    {% if assessments %}
                        {% for assessment in assessments %}
                        <tr>
                            <td class="px-4 py-3 text-sm text-gray-700">{{ assessment.created_at.strftime('%Y-%m-%d') }}</td>
                            <td class="px-4 py-3 text-sm text-gray-700">{{ assessment.assessment_type }}</td>
                            <td class="px-4 py-3 text-sm font-semibold text-blue-600">{{ assessment.score }}</td>
                            <td class="px-4 py-3 text-sm">
                                {% set severity_info = get_severity_info(assessment.assessment_type, assessment.score) %}
                                <span class="px-2 py-1 rounded-full text-xs font-medium bg-{{ severity_info.color }}-100 text-{{ severity_info.color }}-800">{{ severity_info.severity }}</span>
                            </td>
                            <td class="px-4 py-3 text-sm">
                                <button class="text-blue-600 hover:text-blue-800 mr-2" onclick="viewAssessmentDetails({{ assessment.id }})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="5" class="px-4 py-3 text-sm text-gray-600 text-center">No assessments recorded yet.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
        
        <div class="mt-4 p-4 bg-blue-50 rounded-lg">
            <h4 class="font-semibold text-gray-800 mb-2">
                <i class="fas fa-lightbulb text-blue-500 mr-2"></i>AI Insights (Coming Soon)
            </h4>
            <p class="text-sm text-gray-600">
                Our AI will analyze your assessment patterns and provide personalized recommendations for improving your mental well-being.
            </p>
        </div>
    </div>
</div>

<!-- Assessment Modal -->
<div id="assessmentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-2xl mx-4 max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 id="assessmentTitle" class="text-xl font-semibold text-gray-800"></h3>
            <button onclick="closeAssessment()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <div id="assessmentContent">
            <!-- Assessment questions will be loaded here -->
        </div>
        
        <div class="flex justify-between mt-6">
            <button id="prevBtn" onclick="previousQuestion()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg" disabled>
                <i class="fas fa-arrow-left mr-2"></i>Previous
            </button>
            <button id="nextBtn" onclick="nextQuestion()" class="btn-primary">
                Next <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>
    </div>
</div>

<script>
let currentAssessment = null;
let currentQuestion = 0;
let assessmentAnswers = [];
let selectedMood = null;

// Assessment data
const assessments = {
    anxiety: {
        title: "GAD-7 Anxiety Assessment",
        type: "GAD-7",
        description: "Over the last 2 weeks, how often have you been bothered by the following problems?",
        questions: [
            "Feeling nervous, anxious, or on edge",
            "Not being able to stop or control worrying",
            "Worrying too much about different things",
            "Trouble relaxing",
            "Being so restless that it's hard to sit still",
            "Becoming easily annoyed or irritable",
            "Feeling afraid as if something awful might happen"
        ],
        options: [
            { value: 0, text: "Not at all" },
            { value: 1, text: "Several days" },
            { value: 2, text: "More than half the days" },
            { value: 3, text: "Nearly every day" }
        ]
    },
    depression: {
        title: "PHQ-9 Depression Screening",
        type: "PHQ-9",
        description: "Over the last 2 weeks, how often have you been bothered by any of the following problems?",
        questions: [
            "Little interest or pleasure in doing things",
            "Feeling down, depressed, or hopeless",
            "Trouble falling or staying asleep, or sleeping too much",
            "Feeling tired or having little energy",
            "Poor appetite or overeating",
            "Feeling bad about yourself or that you are a failure or have let yourself or your family down",
            "Trouble concentrating on things, such as reading the newspaper or watching television",
            "Moving or speaking so slowly that other people could have noticed, or the opposite being so fidgety or restless that you have been moving around a lot more than usual",
            "Thoughts that you would be better off dead, or of hurting yourself"
        ],
        options: [
            { value: 0, text: "Not at all" },
            { value: 1, text: "Several days" },
            { value: 2, text: "More than half the days" },
            { value: 3, text: "Nearly every day" }
        ]
    }
};

function startAssessment(type) {
    currentAssessment = assessments[type];
    currentQuestion = 0;
    assessmentAnswers = [];
    
    document.getElementById('assessmentTitle').textContent = currentAssessment.title;
    document.getElementById('assessmentModal').classList.remove('hidden');
    
    showQuestion();
}

function showQuestion() {
    const content = document.getElementById('assessmentContent');
    const question = currentAssessment.questions[currentQuestion];
    
    let html = `
        <div class="mb-4">
            <p class="text-gray-600 text-sm mb-4">${currentAssessment.description}</p>
            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                <span class="text-sm text-blue-600">Question ${currentQuestion + 1} of ${currentAssessment.questions.length}</span>
                <div class="w-full bg-blue-200 rounded-full h-2 mt-2">
                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${((currentQuestion + 1) / currentAssessment.questions.length) * 100}%"></div>
                </div>
            </div>
        </div>
        
        <h4 class="text-lg font-medium text-gray-800 mb-4">${question}</h4>
        
        <div class="space-y-3">
    `;
    
    currentAssessment.options.forEach((option, index) => {
        const isSelected = assessmentAnswers[currentQuestion] === option.value;
        html += `
            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 ${isSelected ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}">
                <input type="radio" name="answer" value="${option.value}" class="mr-3" ${isSelected ? 'checked' : ''} onchange="selectAnswer(${option.value})">
                <span class="text-gray-700">${option.text}</span>
            </label>
        `;
    });
    
    html += '</div>';
    content.innerHTML = html;
    
    // Update navigation buttons
    document.getElementById('prevBtn').disabled = currentQuestion === 0;
    const nextBtn = document.getElementById('nextBtn');
    
    if (currentQuestion === currentAssessment.questions.length - 1) {
        nextBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Complete Assessment';
        nextBtn.onclick = completeAssessment;
    } else {
        nextBtn.innerHTML = 'Next <i class="fas fa-arrow-right ml-2"></i>';
        nextBtn.onclick = nextQuestion;
    }
}

function selectAnswer(value) {
    assessmentAnswers[currentQuestion] = value;
}

function nextQuestion() {
    if (assessmentAnswers[currentQuestion] === undefined) {
        alert('Please select an answer before continuing.');
        return;
    }
    
    if (currentQuestion < currentAssessment.questions.length - 1) {
        currentQuestion++;
        showQuestion();
    }
}

function previousQuestion() {
    if (currentQuestion > 0) {
        currentQuestion--;
        showQuestion();
    }
}

async function completeAssessment() {
    if (assessmentAnswers[currentQuestion] === undefined) {
        alert('Please select an answer before completing the assessment.');
        return;
    }
    
    const totalScore = assessmentAnswers.reduce((sum, score) => sum + score, 0);
    const maxScore = currentAssessment.questions.length * 3;

    // Save assessment to backend
    try {
        const response = await fetch('/api/save-assessment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                assessment_type: currentAssessment.type,
                score: totalScore,
                responses: assessmentAnswers
            }),
        });

        const data = await response.json();
        if (data.success) {
            showNotification('Assessment saved successfully!', 'success');
        } else {
            showNotification(`Error saving assessment: ${data.message}`, 'error');
        }
    } catch (error) {
        console.error('Error saving assessment:', error);
        showNotification('An error occurred while saving the assessment.', 'error');
    }
    
    // Show results
    showAssessmentResults(totalScore, maxScore);
}

function showAssessmentResults(score, maxScore) {
    let severity, color, recommendations;
    
    if (currentAssessment.title.includes('GAD-7')) {
        if (score <= 4) {
            severity = 'Minimal';
            color = 'green';
            recommendations = 'Your anxiety levels appear to be minimal. Continue with healthy lifestyle practices.';
        } else if (score <= 9) {
            severity = 'Mild';
            color = 'yellow';
            recommendations = 'You may be experiencing mild anxiety. Consider stress management techniques and monitor your symptoms.';
        } else if (score <= 14) {
            severity = 'Moderate';
            color = 'orange';
            recommendations = 'Moderate anxiety detected. Consider speaking with a mental health professional for support.';
        } else {
            severity = 'Severe';
            color = 'red';
            recommendations = 'Severe anxiety symptoms detected. We strongly recommend consulting with a mental health professional.';
        }
    } else {
        if (score <= 4) {
            severity = 'Minimal';
            color = 'green';
            recommendations = 'Your depression screening shows minimal symptoms. Keep up with healthy habits.';
        } else if (score <= 9) {
            severity = 'Mild';
            color = 'yellow';
            recommendations = 'Mild depression symptoms detected. Consider lifestyle changes and monitor your mood.';
        } else if (score <= 14) {
            severity = 'Moderate';
            color = 'orange';
            recommendations = 'Moderate depression symptoms. Consider professional support and treatment options.';
        } else {
            severity = 'Severe';
            color = 'red';
            recommendations = 'Severe depression symptoms detected. Please seek professional help immediately.';
        }
    }
    
    const content = document.getElementById('assessmentContent');
    content.innerHTML = `
        <div class="text-center">
            <div class="mb-6">
                <div class="bg-${color}-100 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-chart-bar text-${color}-600 text-3xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">Assessment Complete</h3>
                <p class="text-gray-600">Your results have been recorded and will help track your progress over time.</p>
            </div>
            
            <div class="bg-gray-50 p-6 rounded-lg mb-6">
                <div class="text-3xl font-bold text-${color}-600 mb-2">${score}/${maxScore}</div>
                <div class="text-lg font-semibold text-gray-800 mb-2">${severity} Symptoms</div>
                <p class="text-gray-600 text-sm">${recommendations}</p>
            </div>
            
            <div class="space-y-3">
                <button onclick="scheduleFollowUp()" class="btn-primary w-full">
                    <i class="fas fa-calendar mr-2"></i>Schedule Follow-up
                </button>
                <button onclick="viewProgress()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full w-full">
                    <i class="fas fa-chart-line mr-2"></i>View Progress Trends
                </button>
                <button onclick="closeAssessment()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full w-full">
                    <i class="fas fa-home mr-2"></i>Back to Dashboard
                </button>
            </div>
        </div>
    `;
    
    // Hide navigation buttons
    document.querySelector('.flex.justify-between.mt-6').style.display = 'none';
}

function closeAssessment() {
    document.getElementById('assessmentModal').classList.add('hidden');
    currentAssessment = null;
    currentQuestion = 0;
    assessmentAnswers = [];
    // Reload the page to show updated history
    location.reload();
}

function selectMood(mood) {
    selectedMood = mood;
    
    // Remove previous selection
    document.querySelectorAll('.mood-option').forEach(option => {
        option.classList.remove('bg-blue-100', 'border-blue-500', 'border-2');
    });
    
    // Add selection to clicked mood
    const selectedOption = document.querySelector(`[data-mood="${mood}"]`);
    selectedOption.classList.add('bg-blue-100', 'border-blue-500', 'border-2');
    
    // Enable save button
    document.getElementById('saveMoodBtn').disabled = false;
}

async function saveDailyMood() {
    if (selectedMood) {
        try {
            const response = await fetch('/api/save-assessment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    assessment_type: 'Daily Mood',
                    score: selectedMood,
                    responses: { mood: selectedMood }
                }),
            });

            const data = await response.json();
            if (data.success) {
                showNotification(`Daily mood saved! You selected ${selectedMood}/5`, 'success');
                document.getElementById('saveMoodBtn').disabled = true;
                document.getElementById('saveMoodBtn').innerHTML = '<i class="fas fa-check mr-2"></i>Mood Saved for Today';
                // Reload the page to show updated history
                location.reload();
            } else {
                showNotification(`Error saving mood: ${data.message}`, 'error');
            }
        } catch (error) {
            console.error('Error saving daily mood:', error);
            showNotification('An error occurred while saving your mood.', 'error');
        }
    }
}

function scheduleFollowUp() {
    window.location.href = "{{ url_for('schedule') }}";
}

function viewProgress() {
    window.location.href = "{{ url_for('progress') }}";
}

function showNotification(message, type) {
    // This function assumes a notification system is available, e.g., a flash message div in base.html
    // For a quick client-side notification, you might use a simple alert or a custom div that appears/disappears.
    // For now, we'll just log to console and use a simple alert if no flash system is visible.
    console.log(`Notification (${type}): ${message}`);
    // If you have a dedicated notification area, update it here.
    // Example: document.getElementById('notification-area').innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    alert(message); // Fallback for immediate feedback
}

// Helper function to determine severity info for history table
function get_severity_info(assessment_type, score) {
    let severity, color;
    if (assessment_type.includes('GAD-7')) {
        if (score <= 4) { severity = 'Minimal'; color = 'green'; }
        else if (score <= 9) { severity = 'Mild'; color = 'yellow'; }
        else if (score <= 14) { severity = 'Moderate'; color = 'orange'; }
        else { severity = 'Severe'; color = 'red'; }
    } else if (assessment_type.includes('PHQ-9')) {
        if (score <= 4) { severity = 'Minimal'; color = 'green'; }
        else if (score <= 9) { severity = 'Mild'; color = 'yellow'; }
        else if (score <= 14) { severity = 'Moderate'; color = 'orange'; }
        else { severity = 'Severe'; color = 'red'; }
    } else if (assessment_type.includes('Daily Mood')) {
        if (score >= 4) { severity = 'Positive'; color = 'green'; }
        else if (score >= 3) { severity = 'Neutral'; color = 'yellow'; }
        else { severity = 'Negative'; color = 'red'; }
    } else {
        severity = 'N/A'; color = 'gray';
    }
    return { severity: severity, color: color };
}

// Make get_severity_info available in Jinja2 context
// This requires a custom filter or context processor in Flask, 
// but for direct JS usage, we can define it here and call it from Jinja if needed.
// For now, we'll assume Jinja can call it directly or we'll pass it from Flask.
// Given the current setup, it's better to calculate severity in Flask and pass it.
// However, for the purpose of fixing the HTML, I'll define it here for completeness.

// This part is a bit tricky. Jinja2 cannot directly call JavaScript functions.
// The `get_severity_info` function needs to be available in the Flask context.
// I will add a custom filter in app.py for this.
// For now, I'll keep the JS function as a reference for how it would work client-side.

// Function to view assessment details (placeholder for now)
function viewAssessmentDetails(assessmentId) {
    alert(`Viewing details for assessment ID: ${assessmentId}`);
    // In a real app, you'd fetch details via AJAX and display in a modal
}

</script>

<style>
.mood-option:hover {
    transform: scale(1.05);
    transition: transform 0.2s;
}

.mood-option.selected {
    background-color: #dbeafe;
    border: 2px solid #3b82f6;
}
</style>
{% endblock %}
